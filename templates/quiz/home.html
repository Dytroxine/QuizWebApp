{% extends 'base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'quiz/css/styles.css' %}">


    <div class="top-block">

    <img src="{{ quiz.banner.url }}" alt="{{ quiz.title }}" class="banner" id="quiz-banner">
    <div class="time-container" id="time-container">
        <img src="{% static 'main_page/images/vector.png' %}" alt="Timer Icon" class="time-icon">
        <div class="time-text" id="timer-text">{% if quiz.duration_in_minutes == 1 %}
                        {{ quiz.duration_in_minutes }} –º–∏–Ω—É—Ç–∞
                    {% elif quiz.duration_in_minutes < 5 %}
                        {{ quiz.duration_in_minutes }} –º–∏–Ω—É—Ç—ã
                    {% else %}
                        {{ quiz.duration_in_minutes }} –º–∏–Ω—É—Ç
                    {% endif %} </div>
    </div>
    <div class="title" id="quiz-title">Theme: {{ quiz.title }}</div>
    <div class="new-title" id="new-quiz-title">{{ quiz.questions.first.text }}</div>
    <div class="choices-container hidden" id="choices-container">
        {% for choice in quiz.questions.first.choice.all %}
        <img src="{% static 'quiz/images/Component 12.png'%}" class="choice-box-img" id="choice-box-img">
        <button type="button" class="choice-button">{{ choice.text }}</button>
        {% endfor %}
        <button type="button" class="submit-button hidden inactive" id="submit-button">Send</button>
    </div>
</div>
<div class="container" id="loading-container">
    <div class="load-banner" id="load-banner">
        <img class="loading-img" src="{% static 'quiz/images/Frame 17.png'%}" >
        <div class="loading-text" id="loading-text">{{ loadingTexts.0 }}</div>
    </div>
</div>



<script>
        window.addEventListener('load', () => {
            // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            const loadingContainer = document.getElementById('loading-container');
            const loadBanner = document.getElementById('load-banner');
            const boxImg = document.getElementById('choice-box-img');
            const quizBanner = document.getElementById('quiz-banner');
            const quizTitle = document.getElementById('quiz-title');
            const timeContainer = document.getElementById('time-container');
            const newQuizTitle = document.getElementById('new-quiz-title');
            const choicesContainer = document.getElementById('choices-container');
            const submitButton = document.getElementById('submit-button');
            const timerText = document.getElementById('timer-text');
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const socket = new WebSocket(`${protocol}${window.location.host}/ws/quiz/`);
            const userPlace = {{ user_place|default:"null" }};
            const promocode = "{{ promocode|default:'' }}";
            const loadingTexts = {{ loadingTexts|safe }};
            let currentTextIndex = 0;
            const loadingTextElement = document.getElementById('loading-text');
            function deactivateSubmitButton() {
                submitButton.classList.add('inactive');
                submitButton.disabled = true;
            }
            function updateLoadingText() {
            currentTextIndex = (currentTextIndex + 1) % loadingTexts.length;
            loadingTextElement.textContent = loadingTexts[currentTextIndex];
            }
            setInterval(updateLoadingText, 7000);
            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–≤–∏–∑–∞
            let currentQuestionIndex = {{ user_answers_count }}; // –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
            let userAnswers = JSON.parse(localStorage.getItem('userAnswers')) || [];

            // –°–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ Django-—à–∞–±–ª–æ–Ω–∞
            const questions = [
                {% for question in quiz.questions.all %}
                    {
                        id: "{{ question.id }}",
                        text: "{{ question.text|escapejs }}",
                        question_type: "{{ question.question_type }}",
                        correct_answer: "{{ question.correct_answer }}",
                        choices: [
                            {% for choice in question.choice.all %}
                                {
                                    id: {{ choice.id }},
                                    text: "{{ choice.text|escapejs }}",
                                    is_correct: {{ choice.is_correct|yesno:"true,false" }}
                                },
                            {% endfor %}
                        ],
                        timeLimit: {{ question.time_limit }} // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å
                    },
                {% endfor %}
            ];

            let timerInterval; // –¢–∞–π–º–µ—Ä –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ (–º–º:—Å—Å)
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
            function updateQuestion() {
                if (currentQuestionIndex < questions.length) {
    const currentQuestion = questions[currentQuestionIndex];
    const questionId = currentQuestion.id; // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
    newQuizTitle.textContent = currentQuestion.text;

    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤
    choicesContainer.innerHTML = '';

    if (currentQuestion.question_type === "text_input") {
        // –ï—Å–ª–∏ —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ - –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞, —Å–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.className = 'text-input';
        textInput.placeholder = 'type your answer...';

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        textInput.addEventListener('input', () => {
            if (textInput.value.trim().length > 0) {
                activateSubmitButton(); // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            }
        });

        choicesContainer.appendChild(textInput); // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        currentQuestion.choices.forEach(choice => {
            const choiceButton = document.createElement('button');
            choiceButton.className = 'choice-button';
            choiceButton.textContent = choice.text;
            choiceButton.setAttribute('data-choice-id', choice.id); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º data-choice-id

            // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞
            choiceButton.addEventListener('click', (event) => {
                if (currentQuestion.question_type == "multiple_choice") {
                    // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å 'selected'
                    choiceButton.classList.toggle('selected');
                } else {
                    // –û–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                    const allChoices = document.querySelectorAll('.choice-button');
                    allChoices.forEach(button => button.classList.remove('selected'));
                    choiceButton.classList.add('selected');
                }
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                activateSubmitButton();
            });

            choicesContainer.appendChild(choiceButton); // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        });
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "Send"
    choicesContainer.appendChild(submitButton);

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    const savedTime = localStorage.getItem('quiz_timer_' + currentQuestion.id);
    let remainingTime = savedTime ? parseInt(savedTime) : currentQuestion.timeLimit;
    remainingTime = Math.min(remainingTime, currentQuestion.timeLimit);
    timerText.textContent = formatTime(remainingTime);
    clearInterval(timerInterval); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä

    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä
    timerInterval = setInterval(async () => {
        if (remainingTime > 0) {
            remainingTime--;
            localStorage.setItem('quiz_timer_' + currentQuestion.id, remainingTime); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
            timerText.textContent = formatTime(remainingTime);
        } else {
            clearInterval(timerInterval); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
            localStorage.removeItem('quiz_timer_' + currentQuestion.id); // –£–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è

            // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
            const selectedChoices = [];
            const choiceButtons = document.querySelectorAll('.choice-button.selected');
            choiceButtons.forEach(button => {
                selectedChoices.push(parseInt(button.getAttribute('data-choice-id')));
                userAnswers.push(parseInt(button.getAttribute('data-choice-id')));
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –∏ –±–µ—Ä–µ–º –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏–µ
            const textInput = document.querySelector('.text-input');
            let textAnswer = textInput ? textInput.value.trim() : '';
            if (textInput) {
                userAnswers[currentQuestion.id] = textAnswer;
            }
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const telegramId = {{ telegram_id }};

            console.log("–¢–∞–π–º–µ—Ä –∏—Å—Ç—ë–∫, –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤...");

            try {
                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if (textInput) {
                    console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: telegram_id=${telegramId}, text_answer=${textAnswer}`);
                    if (!textAnswer){
                        textAnswer = '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç';
                    }
                    await fetch('/quiz/submit_answer/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegram_id: telegramId,
                            question_id: currentQuestion.id,
                            text_answer: textAnswer
                        })
                    })
                    .then(response => response.json())
                    .then(data => console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data))
                    .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:", error));
                }

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                for (const choiceId of selectedChoices) {
                    console.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: telegram_id=${telegramId}, choice_id=${choiceId}`);

                    await fetch('/quiz/submit_answer/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegram_id: telegramId,
                            choice_id: choiceId
                        })
                    })
                    .then(response => response.json())
                    .then(data => console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data))
                    .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:", error));
                }

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–æ–≤:", error);
            }

            // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
            currentQuestionIndex++;
            updateQuestion();
        }
    }, 1000);
} else {

showIntermediateScreen(userPlace, promocode);
}
}
function showIntermediateScreen(userPlace, promocode) {
    timerText.textContent = '';
    choicesContainer.innerHTML = '';


    const mainContainer = document.querySelector('.container');
    const topBlock = document.querySelector('.top-block');
    const bgImage = document.createElement('img');

    bgImage.src = "{% static 'quiz/images/BG.png' %}"; // –ü—É—Ç—å –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ
    bgImage.style.zIndex = 0;
    bgImage.classList.add('layered-image'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    document.body.appendChild(bgImage);

    // –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    document.querySelector('.banner')?.classList.add('hidden');
    document.querySelector('.title')?.classList.add('hidden');
    document.querySelector('.new-title')?.classList.add('hidden');
    document.querySelector('.logo')?.classList.add('hidden');

    // –î–µ–ª–∞–µ–º —Ñ—É—Ç–µ—Ä –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è
    const footer = document.querySelector('.footer');
    if (footer) {
        footer.style.opacity = '0';
        footer.style.transition = 'opacity 0.5s ease-in-out';
    }

    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ `top-block`
    Array.from(topBlock.children).forEach(child => {

            child.style.display = 'none'; // –ü—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º

    });

    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const container = document.createElement('div');
    container.className = 'intermediate-container';

    // –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ (–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –º–µ—Å—Ç–æ, —Ç–µ–∫—Å—Ç "–º–µ—Å—Ç–æ")
    const resultContainer = document.createElement('div');
    resultContainer.className = 'result-container';

    const resultText = document.createElement('div');
    resultText.textContent = 'Your result:';
    resultText.className = 'result-text';

    const logoContainer = document.createElement('div');
    logoContainer.className = 'logo-container';

    const logoImage = document.createElement('img');
    logoImage.src = '/static/quiz/images/Logotype.png';
    logoImage.alt = 'Logo';

    logoContainer.appendChild(logoImage);
    topBlock.appendChild(logoContainer);

    const placeContainer = document.createElement('div');
    placeContainer.className = 'place-container'; // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–µ—Å—Ç–∞

    const placeNumber = document.createElement('div');
    placeNumber.textContent = userPlace;
    placeNumber.className = 'place-number';

    const placeText = document.createElement('div');
    placeText.textContent = '–º–µ—Å—Ç–æ';
    placeText.className = 'place-text';

    placeContainer.appendChild(placeNumber);
    placeContainer.appendChild(placeText);
    resultContainer.appendChild(resultText);
    resultContainer.appendChild(placeContainer);
    container.appendChild(resultContainer);

    // –í—Ç–æ—Ä–æ–π –±–ª–æ–∫ (–ù–∞–≥—Ä–∞–¥–∞)
    if (promocode) {
        const rewardContainer = document.createElement('div');
        rewardContainer.className = 'reward-container';

        const rewardText = document.createElement('div');
        rewardText.textContent = 'Your reward:';
        rewardText.className = 'reward-text';

        // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–∞–≥—Ä–∞–¥—ã
        const rewardImage = document.createElement('img');
        rewardImage.src = '/static/quiz/images/Group 4.png';
        rewardImage.alt = 'Reward';
        rewardImage.className = 'reward-image';

        // –ü—Ä–æ–º–æ–∫–æ–¥
        const promoCodeContainer = document.createElement('div');
        promoCodeContainer.className = 'promo-code-container';
        const copyButton = document.createElement('img');
copyButton.src = '/static/quiz/images/Copy_btn.png';
copyButton.alt = 'Copy';
copyButton.className = 'copy-button';
copyButton.addEventListener('click', async () => {
    if (navigator.clipboard && window.isSecureContext) {
        try {
            await navigator.clipboard.writeText(promocode);
            console.log('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω:', promocode);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', err);
        }
    } else {
        const tempInput = document.createElement('input');
        document.body.appendChild(tempInput);
        tempInput.value = promocode;
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        console.log('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (fallback):', promocode);
    }
});
promoCodeContainer.appendChild(copyButton);

        const promoCodeText = document.createElement('div');
        promoCodeText.textContent = promocode;

        promoCodeText.className = 'promo-code-text';

        promoCodeContainer.appendChild(promoCodeText);
        rewardContainer.appendChild(rewardText);
        rewardContainer.appendChild(rewardImage);
        rewardContainer.appendChild(promoCodeContainer);
        container.appendChild(rewardContainer);
    }

    const resultButton = document.createElement('button');
    resultButton.textContent = 'Check answers';
    resultButton.className = 'mid-button';
    resultButton.addEventListener('click', showResults);


    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫
const buttonContainer = document.createElement('div');
buttonContainer.className = 'button-container';

// –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "Home"
const homeButton = document.createElement('button');
homeButton.textContent = 'Home';
homeButton.className = 'home-button';
homeButton.addEventListener('click', () => {
    window.location.href = '/{telegramId}'; // –ò–∑–º–µ–Ω–∏ URL, –µ—Å–ª–∏ –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
});

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
buttonContainer.appendChild(homeButton);
buttonContainer.appendChild(resultButton);

// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –æ—Å–Ω–æ–≤–Ω—É—é –æ–±–ª–∞—Å—Ç—å
container.appendChild(buttonContainer);
    container.style.zIndex = 1;
    topBlock.appendChild(container);

    timeContainer.style.display = 'none';
}









    function showResults() {
    // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

    const topBlock = document.querySelector('.top-block');
    document.querySelector('.top-block').style.background = "none";

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ —Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    document.querySelector('.banner')?.classList.remove('hidden');
    document.querySelector('.title')?.classList.remove('hidden');
    document.querySelector('.new-title')?.classList.remove('hidden');
    document.querySelector('.logo-container')?.classList.add('hidden');
    document.querySelector('.time-container')?.classList.add('hidden');
    document.querySelectorAll('.banner, .title, .new-title, .footer, .footer-block, .logo-container, .intermediate-container')
        .forEach(element => {
            const currentZIndex = parseInt(window.getComputedStyle(element).zIndex) || 0;
            element.style.zIndex = currentZIndex + 1;
        });


    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ `top-block`
    Array.from(topBlock.children).forEach(child => {
        if (!child.classList.contains('intermediate-container')) {
            child.style.display = ''; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
        }
    });

    // –£–¥–∞–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `intermediate-container`
    document.querySelector('.intermediate-container')?.remove();


    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    newQuizTitle.textContent = 'Results';
    choicesContainer.innerHTML = '';

    questions.forEach((question, index) => {
        const questionElement = document.createElement('div');
        questionElement.textContent = `${index + 1}. ${question.text}`;
        questionElement.className = 'question-title';
        choicesContainer.appendChild(questionElement);

        if (question.question_type === "text_input") {
    const userAnswerElement = document.createElement('div');
    userAnswerElement.textContent = `${userAnswers[question.id] || "Empty answer"}`;
    userAnswerElement.className = 'choice-button';
    userAnswerElement.style.marginBottom = '8px';
    userAnswerElement.style.cursor = 'default';

    if (question.correct_answer) {
        if (userAnswers[question.id]?.trim().toLowerCase() === question.correct_answer.trim().toLowerCase()) {
            userAnswerElement.style.border = '2px solid #97FF72'; // –ó–µ–ª–µ–Ω–∞—è —Ä–∞–º–∫–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        } else {
            userAnswerElement.style.border = '2px solid #FF5C5C'; // –ö—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –º–∞–ª–µ–Ω—å–∫–∏–º —Å–µ—Ä—ã–º —Ç–µ–∫—Å—Ç–æ–º
            const correctAnswerElement = document.createElement('div');
            correctAnswerElement.textContent = `Correct answer: ${question.correct_answer}`;
            correctAnswerElement.style.fontSize = '12px';
            correctAnswerElement.style.color = '#B0B0B0';
            correctAnswerElement.style.marginTop = '4px';

            userAnswerElement.appendChild(correctAnswerElement);
        }
    }




            choicesContainer.appendChild(userAnswerElement);
        }
        else
            {
                    question.choices.forEach(choice => {
                        const choiceElement = document.createElement('div');
                        const textElement = document.createElement('div');
                        textElement.textContent = choice.text;
                        choiceElement.className = 'choice-button';
                        choiceElement.style.marginBottom = '8px';
                        choiceElement.style.cursor = 'default';

                        const Indicator = document.createElement('div');
                        Indicator.className = 'indicator';
                        Indicator.textContent = '‚úì';
                        Indicator.style.color = '#141414';
                        Indicator.style.marginRight = '18px';
                        Indicator.style.border = '2px solid #414141';
                        Indicator.style.backgroundColor = '#414141';
                        Indicator.style.fontSize = '30px'; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –≥–∞–ª–æ—á–∫–∏
                        Indicator.style.display = 'flex'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º flexbox
                        Indicator.style.alignItems = 'center'; // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
                        Indicator.style.justifyContent = 'center';
                        Indicator.style.fontWeight = 'bold';

                        if (userAnswers.includes(choice.id))
                            {
                                if (choice.is_correct)
                                    {
                                        choiceElement.style.border = '2px solid #97FF72'
                                        Indicator.style.border = '2px solid #97FF72';
                                        Indicator.style.backgroundColor = '#97FF72';
                                        choiceElement.appendChild(Indicator);
                                    }
                                else
                                    {
                                        Indicator.textContent = 'x';
                                        choiceElement.style.border = '2px solid #FF5C5C'
                                        Indicator.style.border = '2px solid #FF5C5C';
                                        Indicator.style.backgroundColor = '#FF5C5C';
                                        choiceElement.appendChild(Indicator);
                                    }
                            }
                        else
                            {
                                if (choice.is_correct)
                                    {
                                        choiceElement.style.border = '2px solid #6f6f6f';
                                        Indicator.style.border = '2px solid #6f6f6f';
                                        Indicator.style.backgroundColor = '#6f6f6f';
                                        choiceElement.appendChild(Indicator);
                                    }
                            }
                        choiceElement.style.display = 'flex';
                        choiceElement.style.flexDirection = 'row';
                        choiceElement.style.alignItems = 'center';
                        choiceElement.style.justifyContent = 'left';
                        choiceElement.appendChild(textElement);
                        choicesContainer.appendChild(choiceElement);

                    });
            }

        const separator = document.createElement('hr');
        separator.style.border = '1px solid #333333';
        separator.style.margin = '16px 0';
        choicesContainer.appendChild(separator);
    });
}














            submitButton.addEventListener('click', async () => {
                deactivateSubmitButton();

                submitButton.textContent = "Send";

                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                const selectedChoices = [];
                const choiceButtons = document.querySelectorAll('.choice-button.selected');
                choiceButtons.forEach(button => {
                    selectedChoices.push(parseInt(button.getAttribute('data-choice-id')));
                });
                const textInput = document.querySelector('.text-input');
                const textAnswer = textInput ? textInput.value.trim() : '';
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
                if (selectedChoices.length === 0 && textAnswer.length === 0) {
                    activateSubmitButton();
                    return;
                }

            });

            // –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞
            function activateSubmitButton() {
                submitButton.classList.remove('inactive');
                submitButton.disabled = false;
                submitButton.textContent = "Send";
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –º–µ—Ä—Ü–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
            function addBlinkingEffect(element) {
                setInterval(() => {
                    element.style.opacity = element.style.opacity === '1' ? '0.5' : '1';
                }, 500); // –ú–µ–Ω—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∫–∞–∂–¥—ã–µ 500 –º—Å
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –º–µ—Ä—Ü–∞–Ω–∏—è –¥–ª—è loadBanner
            addBlinkingEffect(loadBanner);
            {% if quiz.duration_in_minutes == 1 %}
                timerText.textContent = '{{ quiz.duration_in_minutes }} –º–∏–Ω—É—Ç–∞';
            {% elif quiz.duration_in_minutes < 5 %}
                timerText.textContent = '{{ quiz.duration_in_minutes }} –º–∏–Ω—É—Ç—ã';
            {% else %}
                timerText.textContent = '{{ quiz.duration_in_minutes }} –º–∏–Ω—É—Ç';
            {% endif %}

            // –ù–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–∞–Ω–∏–º–∞—Ü–∏—è –∏ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å)
            if ({{ quiz.is_active|yesno:"true,false" }} === true) {
                setTimeout(() => {
                    if (loadBanner) {
                        loadBanner.style.animation = 'none'; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                        loadBanner.style.opacity = '0'; // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–æ 0
                    }
                    if (loadingContainer) {
                        setTimeout(() => {
                            loadingContainer.style.display = 'none'; // –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã—Ç—å
                        }, 500); // –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                    }
                    if (quizBanner) quizBanner.style.top = '82px';
                    if (quizTitle) quizTitle.style.top = '223px';
                    if (timeContainer) timeContainer.style.top = '106px';

                    if (newQuizTitle) {
                        setTimeout(() => {
                            newQuizTitle.style.opacity = '1';
                            updateQuestion(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
                        }, 500);
                    }

                    if (choicesContainer) {
                        setTimeout(() => {
                            choicesContainer.style.opacity = '1';
                        }, 1500);
                    }
                }, 500);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∫–≤–∏–∑–∞
                    const elementsToShow = [
                        document.getElementById('choices-container'),
                        document.getElementById('submit-button'),
                        document.getElementById('choice-box-img')
                    ];

                    elementsToShow.forEach(element => {
                        if (element) element.classList.remove('hidden');
                    });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ WebSocket
            socket.onopen = function() {
                console.log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å WebSocket —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'quiz_update') {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–≤–∏–∑–∞
                }

                if (data.type === 'quiz_end') {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–∏–∑–∞
                }
                if (data.type === "start_quiz") {
                    console.log(`üì¢ –ö–≤–∏–∑ –Ω–∞—á–∞—Ç!`);

                    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Ä—Ü–∞–Ω–∏–µ –∏ —Å–∫—Ä—ã—Ç—å –±–∞–Ω–Ω–µ—Ä
                    if (loadBanner) {
                        loadBanner.style.animation = 'none'; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                        loadBanner.style.opacity = '0'; // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–æ 0
                    }
                    if (loadingContainer) {
                        setTimeout(() => {
                            loadingContainer.style.display = 'none'; // –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã—Ç—å
                        }, 500); // –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                    }
                    if (quizBanner) quizBanner.style.top = '82px';
                    if (quizTitle) quizTitle.style.top = '223px';
                    if (timeContainer) timeContainer.style.top = '106px';
                    if (newQuizTitle) {
                        setTimeout(() => {
                            newQuizTitle.style.opacity = '1';
                            updateQuestion(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
                        }, 500);
                    }

                    if (choicesContainer) {
                        setTimeout(() => {
                            choicesContainer.style.opacity = '1';
                        }, 1500);
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∫–≤–∏–∑–∞
                    const elementsToShow = [
                        document.getElementById('choices-container'),
                        document.getElementById('submit-button')
                    ];

                    elementsToShow.forEach(element => {
                        if (element) element.classList.remove('hidden');
                    });

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
                    updateQuestion();
                }
            }

            // –î–æ–±–∞–≤—å—Ç–µ –∑–¥–µ—Å—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π WebSocket, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
        });
    </script>



{% endblock %}
